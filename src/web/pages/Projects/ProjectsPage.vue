<script lang="ts" setup>
import { Projects, projects as unhydratedProjects } from '@/common/Project'
import { HydrationKey, loadStateFromDom } from '@/web/utils/hydration'
import axios from 'axios'
import { getIconSvgRaw, getProfilePicture, ResponsiveImage } from '@/web/utils/ResponsiveLoader'
import { useMeta } from 'vue-meta'
import { createPageHeadOptions, TwitterCard } from '@/web/utils/PageHeadOptions'
import { formatUrl } from '@/common/utils/formatUrl'
import { useAppContext } from '@/web/app'

const title = 'Projects'
useMeta(createPageHeadOptions({
    title,
    desc: getProjectTitles(),
    image: getProfilePicture().src,
    imageSize: TwitterCard.Summary,
}))

const getImage = (fileName: string): ResponsiveImage => {
    if (fileName.startsWith('https')) {
        return {
            src: fileName,
            width: 0,
            height: 0,
        }
    }

    // eslint-disable-next-line @typescript-eslint/no-var-requires
    return require(`./img/${fileName}`) as ResponsiveImage
}

const projects = await loadProjects()

function getProjectTitles(): string {
    let projectNames: Array<string> = []

    for (const categoryProjects of Object.values(unhydratedProjects)) {
        projectNames = projectNames.concat(categoryProjects.map((project) => project.name))
    }

    return projectNames.join(', ')
}

async function loadProjects(): Promise<Projects> {
    let projects: Projects | undefined

    if (DEFINE.IS_SSR) {
        const ssrContext = useAppContext()
        projects = ssrContext?.projects
    } else {
        projects = loadStateFromDom<Projects>(HydrationKey.Projects)

        if (DEFINE.IS_DEV && projects === undefined) {
            const res = await axios.get<Projects>('/api/projects')
            projects = res.data
        }
    }

    return projects ?? {}
}
</script>

<template>
    <article
        v-for="[category, categoryProjects] of Object.entries(projects)"
        :key="category"
        class="container project-category"
    >
        <h1>
            {{ category }}
        </h1>

        <section
            v-for="project of categoryProjects"
            :key="project.name"
            class="project"
        >
            <div class="preview">
                <SimpleImage
                    v-if="project.img"
                    :img="getImage(project.img)"
                    :title="project.name"
                    :enable-zoom="false"
                    :enable-background="false"
                />
            </div>

            <div class="desc">
                <h2>
                    {{ project.name }}
                </h2>

                <div class="links">
                    <a
                        v-if="project.url"
                        :href="project.url"
                        target="_blank"
                        rel="noopener"
                    >
                        <!-- eslint-disable-next-line vue/no-v-html -->
                        <span class="icon" v-html="getIconSvgRaw('open')" />

                        {{ formatUrl(project.url) }}
                    </a>

                    <a
                        v-if="project.repo && !project.isPrivate"
                        :href="project.repo"
                        target="_blank"
                        rel="noopener"
                    >
                        <!-- eslint-disable-next-line vue/no-v-html -->
                        <span class="icon" v-html="getIconSvgRaw('github')" />

                        GitHub
                    </a>
                </div>

                <p>
                    {{ project.desc }}
                </p>

                <div class="tech">
                    <span
                        v-for="tech of project.tech"
                        :key="tech"
                    >
                        {{ tech }}
                    </span>
                </div>
            </div>
        </section>
    </article>
</template>

<style lang="scss" scoped>
article.project-category{
    display: flex;
    flex-direction: column;
    gap: $column-gap;
    margin-top: $vspace;
    margin-bottom: $vspace;

    .project{
        display: grid;
        gap: $column-gap;
        grid-template-columns: (100% - $container-width) 1fr;

        @media (max-width: $large-mobile-breakpoint) {
            gap: $padding * 2;
            grid-template-columns: 1fr;
        }

        .preview{
            .simple-image{
                background: $dark;
                border: math.div($padding, 2) solid $dark;
            }
        }

        .desc{
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: $padding;

            p{
                line-height: $padding * 2;
            }

            .links{
                display: flex;
                flex-direction: column;
                gap: $padding;

                a{
                    $icon-size: $padding * 1.5;

                    align-items: center;
                    display: flex;
                    gap: math.div($padding, 2);
                    line-height: $icon-size;

                    .icon{
                        align-items: center;
                        display: flex;

                        svg{
                            width: $icon-size;
                            height: $icon-size;
                        }
                    }
                }
            }

            .tech{
                display: flex;
                flex-wrap: wrap;
                gap: math.div($padding, 2) $padding;

                span{
                    color: lighten($dark, 30%);
                    font-size: 1rem;
                }
            }
        }
    }
}
</style>
